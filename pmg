#!/bin/bash
# PMG - PNETLab Manager
# Version: 3.2
# Based on ishare2-cli
# Modified to use correct LabHub API endpoints

# Default configuration
USE_ARIA2C=false
SSL_CHECK="true"
CHANNEL="main"
VERSION="3.2"

# Initialize variables
PMG_DIR="/opt/pmg"
LOG_FILE="$PMG_DIR/pmg.log"
TEMP_JSON="$PMG_DIR/labhub.json"

# API Configuration - CORRIGIDO
API_BASE_URL="https://labhub.eu.org/0:/addons"
DRIVE_API_URL="https://labhub.eu.org/0:/addons"

# Colors
RED='\033[31m'
YELLOW='\033[1;33m'
GREEN='\033[32m'
BLUE='\033[34m'
NO_COLOR='\033[0m'

# Script name
SCR_NAME_EXEC=$0
SCR_NAME_EXEC_FP=$(realpath "$0")
SCR_NAME=$(basename "$SCR_NAME_EXEC")
SCR_NAME=${SCR_NAME%.*}

# Configuration file
PMG_CONF_FILE=$PMG_DIR/pmg.conf

logger() {
    local log_level=${1^^}
    shift

    if [[ ! -f "$LOG_FILE" ]]; then
        touch "$LOG_FILE"
    fi

    if [[ -z "$LOG_FILE" ]]; then
        echo "LOG_FILE is not set" >&2
        return 1
    elif [[ ! -w "$LOG_FILE" && ! -e "$LOG_FILE" ]]; then
        echo "Cannot write to LOG_FILE: $LOG_FILE" >&2
        touch "$LOG_FILE" || return 1
        chmod 644 "$LOG_FILE" || return 1
        return 1
    fi

    if [[ -z "$SCR_NAME" ]]; then
        SCR_NAME="UNKNOWN_SCRIPT"
    fi

    echo -e "[$log_level][$SCR_NAME] $(date '+%Y-%m-%d %H:%M:%S'): $*" >>"$LOG_FILE"
}

print_box() {
    messages=("$@")
    max_length=0
    IFS=$'\n'
    all_lines=()
    for message in "${messages[@]}"; do
        readarray -t lines <<<"$message"
        for line in "${lines[@]}"; do
            all_lines+=("$line")
            length=${#line}
            if ((length > max_length)); then
                max_length=$length
            fi
        done
    done
    IFS=$' \t\n'

    echo -e "${YELLOW}┌$(printf '─%.0s' $(seq 1 $((max_length + 4))))┐${NO_COLOR}"
    for line in "${all_lines[@]}"; do
        printf "${YELLOW}│${NO_COLOR} %-$(($max_length + 2))s ${YELLOW}│${NO_COLOR}\n" "$line"
    done
    echo -e "${YELLOW}└$(printf '─%.0s' $(seq 1 $((max_length + 4))))┘${NO_COLOR}"
}

print_separator() {
    local TITLE=$1
    local WIDTH=${#TITLE}
    local SEPARATOR=""

    for ((i = 0; i < WIDTH + 8; i++)); do
        SEPARATOR+="="
    done

    echo -e "${BLUE}$SEPARATOR${NO_COLOR}"
    echo -e "\033[1;33m    ${TITLE}    \033[0m"
    echo -e "${BLUE}$SEPARATOR${NO_COLOR}"
}

check_user_is_root() {
    if ! [[ "$(id -u)" == 0 ]]; then
        user=$(whoami)
        echo -e "${RED}[!] This script requires root privileges. Current user \"$user\" does not have enough permissions.${NO_COLOR}"
        exit 1
    fi
}

is_pnetlab_installed() {
    data=$(mysql -uroot -ppnetlab -D pnetlab_db -e "SELECT control_value FROM control WHERE control_value>1;" 2>/dev/null)
    data_array=("$data")
    pnetlab_version=${data_array[1]}
    if [[ -z $pnetlab_version ]]; then
        echo -e "${YELLOW}[!] WARN: PNetLab was not found.${NO_COLOR}"
        logger warn "PNetLab is not installed."
        return 1
    fi
    return 0
}

check_pmg_dir() {
    if [[ ! -d $PMG_DIR ]]; then
        create_pmg_dir
    fi
}

create_pmg_dir() {
    echo -e "${YELLOW}[!] Creating PMG directory...${NO_COLOR}"
    if ! mkdir -p $PMG_DIR 2>/dev/null; then
        error_message=$(mkdir -p $PMG_DIR 2>&1 >/dev/null)
        if [[ $error_message == *"Permission denied"* ]]; then
            echo -e "${RED}[-] Failed to create PMG directory: Permission denied.${NO_COLOR}"
        else
            echo -e "${RED}[-] Failed to create PMG directory. Error: $error_message${NO_COLOR}"
        fi
        exit 1
    fi
    logger info "PMG directory created successfully."
}

install_dependencies() {
    echo -e "${YELLOW}[+] PMG needs to install some dependencies to work properly.${NO_COLOR}"
    local packages=("curl" "wget" "jq" "unrar" "tree" "unzip")
    echo -e "${YELLOW}[+] List of packages to be installed: ${NO_COLOR}"
    for package in "${packages[@]}"; do
        echo -e "${YELLOW} -${NO_COLOR} $package"
    done
    echo -e "${YELLOW}[+] Starting to install dependencies in 5 seconds...${NO_COLOR}"
    sleep 5

    for package in "${packages[@]}"; do
        install_package "$package"
    done
}

install_package() {
    local package_name=$1
    if ! command -v "$package_name" &>/dev/null; then
        echo -e "${YELLOW}[+] $package_name is not installed.${NO_COLOR}"
        apt-get update -qq
        echo -e "${YELLOW}[+] Installing $package_name...${NO_COLOR}"
        if ! apt-get install -qq -y "$package_name"; then
            echo -e "${RED}[-] Failed to install $package_name.${NO_COLOR}"
            logger error "Failed to install $package_name."
            exit 1
        fi
    else
        echo -e "${GREEN}[+] $package_name is already installed.${NO_COLOR}"
        logger info "Package $package_name is already installed."
    fi
}

# Função para buscar o índice JSON da API corrigida
fetch_json() {
    check_installed "jq"
    
    logger info "Fetching JSON index from LabHub API"
    
    # URL corrigida para a API do LabHub
    JSON_INDEX_URL="https://labhub.eu.org/0:/addons/.lab-index.json"
    
    logger info "Downloading index from: $JSON_INDEX_URL"
    
    if curl -sSL -o "$TEMP_JSON" "$JSON_INDEX_URL"; then
        logger info "JSON index downloaded successfully."
    else
        logger error "Failed to download JSON index from: $JSON_INDEX_URL"
        echo -e "${RED}[-] Failed to download the JSON index file. Check your internet connection.${NO_COLOR}"
        connection_tests
        exit 1
    fi

    # Validate downloaded JSON
    if ! jq -e . <"$TEMP_JSON" >/dev/null 2>&1; then
        logger error "Invalid JSON structure in: $TEMP_JSON"
        echo -e "${RED}[-] Error: Invalid JSON index file.${NO_COLOR}"
        exit 1
    else
        logger info "Valid JSON file confirmed: $TEMP_JSON"
    fi
}

check_installed() {
    PACKAGE=$1
    if ! command -v "$PACKAGE" &>/dev/null; then
        echo -e "${YELLOW}[!] WARN: $PACKAGE is not installed.${NO_COLOR}"
        install_package "$PACKAGE"
        if ! command -v "$PACKAGE" &>/dev/null; then
            echo -e "${RED}[-] Error: Failed to install $PACKAGE.${NO_COLOR}"
            logger error "Failed to install $PACKAGE."
            exit 1
        else
            echo -e "${GREEN}[+] $PACKAGE has been installed successfully.${NO_COLOR}"
        fi
    fi
}

download_file() {
    local url="$1"
    local output="$2"
    USE_ARIA2C=$(grep "USE_ARIA2C" $PMG_CONF_FILE 2>/dev/null | cut -d "=" -f2)
    
    logger info "Downloading file from $url to $output"

    if [[ $USE_ARIA2C == "true" ]]; then
        if ! command -v aria2c &>/dev/null; then
            echo -e "${RED}[-] Error: aria2c is not installed. Installing...${NO_COLOR}"
            install_package "aria2"
        fi
    fi

    if command -v aria2c &>/dev/null && [[ $USE_ARIA2C == "true" ]]; then
        download_file_aria2 "$url" "$output"
    else
        download_file_wget "$url" "$output"
    fi
}

download_file_wget() {
    mkdir -p $PMG_DIR/tmp
    local url="$1"
    local output_dir="$2"
    local output_name="$3"
    if [[ -z "$output_name" ]]; then
        output_name=$(basename "$url")
    fi
    local output="$output_dir/$output_name"
    logger info "Downloading file from $url..."

    if [ "$SSL_CHECK" = true ]; then
        wget -O "$output" "$url" -q --show-progress --content-disposition -T 300
    else
        wget -O "$output" "$url" -q --show-progress --content-disposition --no-check-certificate -T 300
    fi

    if [ $? -eq 0 ]; then
        logger info "The file has been downloaded successfully to $output."
    else
        echo -e "${RED}[-] Error: Unable to download the file. ${NO_COLOR}"
        logger error "Failed to download the file."
        exit 1
    fi
}

search_images() {
    TYPE=${1^^}
    FILTER=${2:-}

    fetch_json

    print_separator "Available $TYPE images"

    data=$(jq -r --arg type "$TYPE" --arg filter "$FILTER" '
      .[$type][] 
      | select(($filter | length == 0) or (.name | test($filter; "i"))) 
      | [.id, .name, .size] 
      | @tsv' "$TEMP_JSON")

    if [[ -z "$data" ]]; then
        echo -e "\n${RED}No $TYPE images found for \"$FILTER\"${NO_COLOR}"
    else
        {
            echo -e "ID\tNAME\tSIZE"
            echo -e "--\t----\t----"
            echo "$data"
        } | column -t -s $'\t'

        total_count=$(echo "$data" | wc -l)
        echo -e "\n${GREEN}$total_count $TYPE image(s) found${NO_COLOR}"
    fi
    echo -e "${YELLOW}[!] ${NO_COLOR}You can use the command \033[32mpmg pull <type> <id>\033[0m to download the image"
}

pull_images() {
    local IMAGE_TYPE=$1
    local IMAGE_ID=$2
    local OVERWRITE=$3

    [[ -z "$IMAGE_TYPE" ]] && {
        echo "Usage: pmg pull <type> <id>"
        exit 1
    }
    [[ -z "$IMAGE_ID" || ! "$IMAGE_ID" =~ ^[0-9]+$ ]] && {
        echo "Invalid ID"
        exit 1
    }

    IMAGE_TYPE=${IMAGE_TYPE^^}
    [[ "$IMAGE_TYPE" == "BIN" ]] && IMAGE_TYPE="IOL"
    [[ ! "$IMAGE_TYPE" =~ ^(QEMU|IOL|DYNAMIPS)$ ]] && {
        echo "Invalid type"
        exit 1
    }

    fetch_json

    local image_data image_name install_path download_url

    image_data=$(jq -r --arg type "$IMAGE_TYPE" --argjson id "$IMAGE_ID" \
        '.[$type][] | select(.id == $id)' "$TEMP_JSON")
    [[ -z "$image_data" ]] && {
        echo "Image not found"
        exit 1
    }

    image_name=$(jq -r '.name' <<<"$image_data")
    install_path=$(jq -r '.path' <<<"$image_data")
    
    # Construir URL de download usando a API corrigida
    download_url="${DRIVE_API_URL}/${IMAGE_TYPE}/${image_name}"

    echo -e "${YELLOW}[!] IMAGE INFO ${NO_COLOR}"
    printf "%-20s: %s\n" "Name" "$image_name"
    printf "%-20s: %s\n" "Type" "$IMAGE_TYPE"
    printf "%-20s: %s\n" "Path" "$install_path"
    printf "%-20s: %s\n" "URL" "$download_url"

    if [ -e "$install_path/$image_name" ] && [ "$OVERWRITE" != "--overwrite" ]; then
        echo "File exists. Use --overwrite"
        exit 0
    fi

    mkdir -p "$install_path"
    download_file "$download_url" "$install_path" "$image_name"

    echo -e "${GREEN}[✓] Installation completed successfully! ${NO_COLOR}"
}

connection_tests() {
    declare -A SERVICES=(
        ["LabHub Main"]="labhub.eu.org"
        ["LabHub Drive"]="drive.labhub.eu.org"
        ["GitHub"]="github.com"
        ["Google DNS"]="8.8.8.8"
    )

    local all_services_reachable=true

    echo -e "${YELLOW}[-] Running connection tests... ${NO_COLOR}"

    for service in "${!SERVICES[@]}"; do
        echo -e "${YELLOW}[-] Checking if $service is reachable... ${NO_COLOR}"
        if ping -q -c 5 -W 5 "${SERVICES[$service]}" >/dev/null; then
            echo -e "${GREEN}[+] $service is reachable. ${NO_COLOR}"
        else
            echo -e "${RED}[-] $service is not reachable. ${NO_COLOR}"
            all_services_reachable=false
        fi
    done

    if [ "$all_services_reachable" = true ]; then
        echo -e "${GREEN}[+] All services are reachable. ${NO_COLOR}"
        return 0
    else
        echo -e "${RED}[-] Some services are not reachable. ${NO_COLOR}"
        return 1
    fi
}

show_help() {
    cat <<EOF
PMG - PNETLab Manager v$VERSION

Syntax: pmg [action] [param1] [param2] [--overwrite]

Actions:
    search      : Search for images by type
    pull        : Download an image by type and id
    test        : Test internet connectivity
    help        : Show this help message
    version     : Show PMG version

Examples:
    pmg search qemu
    pmg search qemu win
    pmg pull qemu 1
    pmg pull qemu 1 --overwrite
    pmg test

API Endpoints:
    Main: $DRIVE_API_URL
    Base: $API_BASE_URL
EOF
}

show_version() {
    echo "PMG v$VERSION"
    echo "Modified from ishare2-cli"
    echo "API: $DRIVE_API_URL"
}

create_config() {
    echo "USE_ARIA2C=false" >"$PMG_CONF_FILE"
    echo "SSL_CHECK=true" >>"$PMG_CONF_FILE"
    echo "CHANNEL=main" >>"$PMG_CONF_FILE"
}

check_config() {
    if [[ ! -f $PMG_CONF_FILE ]]; then
        create_config
    fi
    source "$PMG_CONF_FILE"
}

selector() {
    case "$1" in
    "search")
        TYPE_INPUT="${2,,}"
        QUERY="${3:-}"
        case "$TYPE_INPUT" in
        "qemu" | "iol" | "dynamips")
            search_images "${TYPE_INPUT}" "$QUERY"
            ;;
        *)
            search_images "ANY" "$TYPE_INPUT"
            ;;
        esac
        ;;
    "pull")
        pull_images "$2" "$3" "$4"
        ;;
    "test")
        connection_tests
        ;;
    "help" | "--help" | "-h")
        show_help
        ;;
    "version" | "--version" | "-v")
        show_version
        ;;
    *)
        echo "Invalid command. Use 'pmg help' for usage information."
        exit 1
        ;;
    esac
}

# Main execution
check_user_is_root
check_pmg_dir
check_config
install_dependencies

if [ $# -eq 0 ]; then
    show_help
else
    selector "$@"
fi
